suite: Test Deployment template with CI Values
templates:
  - templates/deployment.yaml
values:
  - ../ci-values.yaml
release:
  namespace: test-namespace
tests:
  - it: should render deployment with values from ci-values.yaml
    asserts:
      # ─────────────── metadata ───────────────
      - equal:
          path: metadata.name
          value: test-app
      - equal:
          path: metadata.namespace
          value: test-namespace
      - equal:
          path: metadata.annotations.custom-annotation
          value: "true"

      # ─────────────── spec.replicas ───────────────
      - equal:
          path: spec.replicas
          value: 3

      # ─────────────── selector.matchLabels ───────────────
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: test-app

      # ─────────────── template labels ───────────────
      - isNotEmpty:
          path: spec.template.metadata.labels

      # ─────────────── container.image ───────────────
      - equal:
          path: spec.template.spec.containers[0].image
          value: "docker.io/test-image:v1.2.3"
      - equal:
          path: spec.template.spec.containers[0].name
          value: test-app
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

      # ─────────────── serviceAccount ───────────────
      - equal:
          path: spec.template.spec.serviceAccountName
          value: test-sa

      # ─────────────── resources ───────────────
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "500m"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "128Mi"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: "250m"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "64Mi"

      # ─────────────── probes ───────────────
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].startupProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /ready
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /live
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 5

      # ─────────────── strategy ───────────────
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 2
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 2
