suite: Test Deployment template with CI Values
templates:
  - templates/deployment.yaml
values:
  - ../ci-values.yaml
release:
  namespace: test-namespace
tests:
  - it: should not render deployment if disabled
    set:
      name: test-app
      deployment:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0
  - it: should render deployment with values from ci-values.yaml
    asserts:
      - isKind:
          of: Deployment
      # ─────────────── metadata ───────────────
      - equal:
          path: metadata.name
          value: test-app
      - equal:
          path: metadata.namespace
          value: test-namespace
      - equal:
          path: metadata.annotations.custom-annotation
          value: "true"

      # ─────────────── spec.replicas ───────────────
      - equal:
          path: spec.replicas
          value: 3

      # ─────────────── selector.matchLabels ───────────────
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: test-app

      # ─────────────── template labels ───────────────
      - isNotEmpty:
          path: spec.template.metadata.labels

      # ─────────────── container.image ───────────────
      - equal:
          path: spec.template.spec.containers[0].image
          value: "docker.io/test-image:v1.3.0"
      - equal:
          path: spec.template.spec.containers[0].name
          value: container-1

      # ─────────────── serviceAccount ───────────────
      - equal:
          path: spec.template.spec.serviceAccountName
          value: test-sa
      # ─────────────── termination period ───────────────
      - equal:
          path: spec.template.spec.terminationGracePeriodSeconds
          value: 40
      # ─────────────── security context ───────────────
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          value: ["ALL"]
      - equal:
          path: spec.template.spec.containers[0].securityContext.seccompProfile.type
          value: RuntimeDefault
      - equal:
          path: spec.template.spec.containers[0].securityContext.appArmorProfile.type
          value: RuntimeDefault
      # ─────────────── resources ───────────────
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "500m"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "128Mi"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: "250m"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "64Mi"
      # ─────────────── probes ───────────────
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.port
          value: 8081
      - equal:
          path: spec.template.spec.containers[0].startupProbe.failureThreshold
          value: 2
      - equal:
          path: spec.template.spec.containers[0].startupProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /ready
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8081
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 2
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /live
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8081
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 2
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 5
      # ─────────────── volumes ───────────────
      - equal:
          path: spec.template.spec.volumes[0].name
          value: data
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].name
          value: /data
      # ─────────────── strategy ───────────────
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 2
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 2
